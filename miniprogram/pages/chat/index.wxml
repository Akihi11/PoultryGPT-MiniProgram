<!--pages/chat/index.wxml-->
<view class="container">
  <!-- 顶部导航栏 -->
  <view class="header gradient-bg">
    <view class="header-left">
      <view class="menu-icon" bindtap="toggleSidebar">☰</view>
      <view class="new-chat-icon" bindtap="newChat">+</view>
    </view>
    
    <view class="header-center" bindtap="showModelSelector">
      <text class="model-name">{{currentModel}}</text>
      <text class="dropdown-arrow">▼</text>
    </view>
  </view>
  
  <!-- 聊天内容区域 -->
  <scroll-view class="chat-content" scroll-y scroll-into-view="{{scrollIntoView}}" scroll-with-animation>
    <!-- 欢迎消息 -->
    <view class="welcome-message" wx:if="{{messages.length === 0}}">
      <view class="empty-icon">🐤</view>
      <view class="empty-text">欢迎使用 PoultryGPT</view>
      <view class="empty-subtext">我是您的家禽养殖专业助手，有什么问题都可以问我</view>
    </view>
    
    <!-- 消息列表 -->
    <view wx:for="{{messages}}" wx:key="id" id="msg-{{item.id}}" class="message-container">
      <!-- 用户消息 -->
      <view wx:if="{{item.type === 'user'}}" class="message user-message">
        <view class="avatar-emoji avatar-user">👤</view>
        <view class="message-content">
          <view class="message-bubble message-bubble-user">{{item.content}}</view>
        </view>
      </view>
      
      <!-- AI消息 -->
      <view wx:if="{{item.type === 'ai'}}" class="message ai-message">
        <view class="avatar-emoji avatar-ai">🐤</view>
        <view class="ai-message-content">
          <!-- 任务编排模块 -->
          <view wx:if="{{item.workflow && item.workflow.length > 0}}" class="task-card">
            <view class="task-header" bindtap="toggleWorkflow" data-id="{{item.id}}">
              <text class="task-title">任务编排</text>
              <text class="expand-icon">{{item.workflowExpanded ? '▼' : '▶'}}</text>
            </view>
            <view class="task-steps" wx:if="{{item.workflowExpanded}}">
              <view wx:for="{{item.workflow}}" wx:key="name" wx:for-item="step" class="task-step">
                <view class="step-check">✓</view>
                <text>{{step.name}}</text>
              </view>
            </view>
          </view>
          
          <!-- AI回复内容 -->
          <view class="message-bubble message-bubble-ai">
            <rich-text nodes="{{item.content}}"></rich-text>
          </view>
        </view>
      </view>
    </view>
    
    <!-- 打字效果占位 -->
    <view wx:if="{{isTyping}}" class="message ai-message">
      <view class="avatar-emoji avatar-ai">🐤</view>
      <view class="message-content">
        <view class="message-bubble message-bubble-ai">
          <text class="typing-indicator">正在思考中...</text>
        </view>
      </view>
    </view>
  </scroll-view>
  
  <!-- 底部输入框 -->
  <view class="input-footer">
    <view class="input-container">
      <t-input
        class="message-input"
        value="{{inputValue}}"
        placeholder="请输入您的问题..."
        bind:change="onInputChange"
        bind:confirm="sendMessage"
        confirm-type="send"
        maxlength="500"
      />
      <view class="input-actions">
        <t-button
          wx:if="{{!inputValue}}"
          class="add-button"
          icon="add"
          variant="text"
          size="large"
          shape="circle"
          bind:tap="showActionSheet"
        />
        <t-button
          wx:else
          class="send-button"
          icon="arrow-right"
          theme="primary"
          size="large"
          shape="circle"
          bind:tap="sendMessage"
        />
      </view>
    </view>
  </view>
</view>

<!-- 模型选择器 -->
<t-action-sheet
  visible="{{showModelSheet}}"
  items="{{modelOptions}}"
  bind:selected="onModelSelect"
  bind:cancel="hideModelSelector"
  description="选择AI模型"
/>

<!-- 操作选择器 -->
<t-action-sheet
  visible="{{showActionOptions}}"
  items="{{actionOptions}}"
  bind:selected="onActionSelect"
  bind:cancel="hideActionSheet"
  description="添加内容"
/>

<!-- 侧边栏历史记录 -->
<view wx:if="{{showSidebar}}" class="sidebar-mask" bindtap="hideSidebar">
  <view class="sidebar-content" catchtap="preventClose">
    <!-- 侧边栏头部 - 与设置页面高度一致 -->
    <view class="sidebar-header gradient-bg">
      <view class="sidebar-header-content">
        <!-- 搜索框 -->
        <input 
          class="sidebar-search-input"
          value="{{searchValue}}"
          placeholder="搜索历史记录"
          bindinput="onSearchInput"
          confirm-type="search"
          bindconfirm="onSearchConfirm"
        />
        <!-- 设置按钮 -->
        <view class="sidebar-settings-btn" bindtap="navigateToSettings">⚙️</view>
      </view>
    </view>
    
    <!-- 历史记录列表 -->
    <scroll-view scroll-y style="flex: 1; padding: 16rpx 0;">
      <!-- 历史记录项目 -->
      <view wx:for="{{searchValue ? filteredHistory : historyList}}" wx:key="id" 
            class="sidebar-history-item"
            bindtap="openHistory" data-id="{{item.id}}">
        <view class="sidebar-item-title">{{item.title}}</view>
        <view class="sidebar-item-preview">{{item.preview}}</view>
        <view class="sidebar-item-time">{{item.time}}</view>
      </view>
      
      <!-- 空状态 - 搜索无结果 -->
      <view wx:if="{{searchValue && filteredHistory.length === 0}}" style="padding: 80rpx 0; text-align: center;">
        <view style="font-size: 80rpx; margin-bottom: 20rpx;">🔍</view>
        <view style="font-size: 28rpx; color: #666; margin-bottom: 10rpx;">未找到相关记录</view>
        <view style="font-size: 24rpx; color: #999;">请尝试其他关键词</view>
      </view>
      
      <!-- 空状态 - 无历史记录 -->
      <view wx:elif="{{!searchValue && historyList.length === 0}}" style="padding: 80rpx 0; text-align: center;">
        <view style="font-size: 80rpx; margin-bottom: 20rpx;">💬</view>
        <view style="font-size: 28rpx; color: #666; margin-bottom: 10rpx;">暂无历史记录</view>
        <view style="font-size: 24rpx; color: #999;">开始您的第一次对话吧</view>
      </view>
    </scroll-view>
  </view>
</view>
