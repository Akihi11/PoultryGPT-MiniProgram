<!--pages/chat/index.wxml-->
<view class="container" style="{{containerStyle}}">
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <view class="header gradient-bg">
    <view class="header-left">
      <view class="menu-icon" bindtap="toggleSidebar">â˜°</view>
      <view class="new-chat-icon" bindtap="newChat">âœ›</view>
    </view>
    
    <view class="header-center" bindtap="showModelSelector">
      <text class="model-name">{{currentModel}}</text>
      <text class="dropdown-arrow">â–¼</text>
    </view>
  </view>
  
  <!-- èŠå¤©å†…å®¹åŒºåŸŸ -->
  <scroll-view class="chat-content" scroll-y scroll-into-view="{{scrollIntoView}}" scroll-with-animation>
    <!-- æ¬¢è¿æ¶ˆæ¯ -->
    <view class="welcome-message" wx:if="{{messages.length === 0}}">
      <view class="empty-icon">ğŸ¤</view>
      <view class="empty-text">æ¬¢è¿ä½¿ç”¨ PoultryGPT</view>
      <view class="empty-subtext">æˆ‘æ˜¯æ‚¨çš„å®¶ç¦½å…»æ®–ä¸“ä¸šåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆé—®é¢˜éƒ½å¯ä»¥é—®æˆ‘</view>
    </view>
    
    <!-- æ¶ˆæ¯åˆ—è¡¨ -->
    <view wx:for="{{messages}}" wx:key="id" id="msg-{{item.id}}" class="message-container">
      <!-- ç”¨æˆ·æ¶ˆæ¯ -->
      <view wx:if="{{item.type === 'user'}}" class="message user-message">
        <view class="avatar-emoji avatar-user">ğŸ‘¤</view>
        <view class="message-content">
          <view class="message-bubble message-bubble-user">{{item.content}}</view>
        </view>
      </view>
      
      <!-- AIæ¶ˆæ¯ -->
      <view wx:if="{{item.type === 'ai'}}" class="message ai-message">
        <view class="avatar-emoji avatar-ai">ğŸ¤</view>
        <view class="ai-message-content">
          <!-- ä»»åŠ¡ç¼–æ’æ¨¡å— -->
          <view wx:if="{{item.workflow && item.workflow.length > 0}}" class="task-card">
            <view class="task-header" bindtap="toggleWorkflow" data-id="{{item.id}}">
              <text class="task-title">ä»»åŠ¡ç¼–æ’</text>
              <text class="expand-icon">{{item.workflowExpanded ? 'â–¼' : 'â–¶'}}</text>
            </view>
            <view class="task-steps" wx:if="{{item.workflowExpanded}}">
              <view wx:for="{{item.workflow}}" wx:key="name" wx:for-item="step" class="task-step">
                <view class="step-check">âœ“</view>
                <text>{{step.name}}</text>
              </view>
            </view>
          </view>
          
          <!-- AIå›å¤å†…å®¹ -->
          <view class="message-bubble message-bubble-ai">
            <rich-text nodes="{{item.content}}"></rich-text>
          </view>
        </view>
      </view>
    </view>
    
    <!-- æ‰“å­—æ•ˆæœå ä½ -->
    <view wx:if="{{isTyping}}" class="message ai-message">
      <view class="avatar-emoji avatar-ai">ğŸ¤</view>
      <view class="message-content">
        <view class="message-bubble message-bubble-ai">
          <text class="typing-indicator">æ­£åœ¨æ€è€ƒä¸­...</text>
        </view>
      </view>
    </view>
  </scroll-view>
  
  <!-- åº•éƒ¨è¾“å…¥æ¡† -->
  <view class="input-footer">
    <view class="input-container">
      <t-input
        class="message-input"
        value="{{inputValue}}"
        placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..."
        bind:change="onInputChange"
        bind:confirm="sendMessage"
        confirm-type="send"
        maxlength="500"
      />
      <view class="input-actions">
        <t-button
          wx:if="{{!inputValue}}"
          class="add-button"
          icon="add"
          variant="text"
          size="large"
          shape="circle"
          bind:tap="showActionSheet"
        />
        <t-button
          wx:else
          class="send-button"
          icon="arrow-right"
          theme="primary"
          size="large"
          shape="circle"
          bind:tap="sendMessage"
        />
      </view>
    </view>
  </view>
</view>

<!-- æ¨¡å‹é€‰æ‹©å™¨ -->
<view wx:if="{{showModelSheet}}" class="model-selector-mask" bindtap="hideModelSelector">
  <view class="model-selector-content" catchtap="preventClose">
    <view class="model-selector-header">
      <text class="model-selector-title">é€‰æ‹©AIæ¨¡å‹</text>
      <view class="model-selector-close" bindtap="hideModelSelector">Ã—</view>
    </view>
    <view class="model-selector-list">
      <view 
        wx:for="{{modelOptions}}" 
        wx:key="value"
        class="model-option {{currentModel === item.value ? 'selected' : ''}}"
        bindtap="selectModel"
        data-value="{{item.value}}"
        data-label="{{item.label}}"
      >
        <text class="model-option-label">{{item.label}}</text>
        <view wx:if="{{currentModel === item.value}}" class="model-option-check">âœ“</view>
      </view>
    </view>
  </view>
</view>

<!-- æ“ä½œé€‰æ‹©å™¨ -->
<view wx:if="{{showActionOptions}}" class="action-options-mask" bindtap="hideActionSheet">
  <view class="action-options-content" catchtap="preventClose">
    <view class="action-options-list">
      <view
        wx:for="{{actionOptions}}"
        wx:key="value"
        class="action-option-item"
        bindtap="onActionSelect"
        data-value="{{item.value}}"
      >
        <view class="action-option-icon icon-{{item.icon}}"></view>
        <text class="action-option-label">{{item.label}}</text>
      </view>
    </view>
  </view>
</view>

<!-- ä¾§è¾¹æ å†å²è®°å½• -->
<view wx:if="{{showSidebar}}" class="sidebar-mask" bindtap="hideSidebar">
  <view class="sidebar-content" catchtap="preventClose">
    <!-- ä¾§è¾¹æ å¤´éƒ¨ - ä¸è®¾ç½®é¡µé¢é«˜åº¦ä¸€è‡´ -->
    <view class="sidebar-header gradient-bg">
      <view class="sidebar-header-content">
        <!-- è®¾ç½®æŒ‰é’® -->
        <view class="sidebar-settings-btn" bindtap="navigateToSettings">âš™ï¸</view>
        <!-- æœç´¢æ¡† -->
        <input 
          class="sidebar-search-input"
          value="{{searchValue}}"
          placeholder="æœç´¢å†å²è®°å½•"
          bindinput="onSearchInput"
          confirm-type="search"
          bindconfirm="onSearchConfirm"
        />
      </view>
    </view>
    
    <!-- å†å²è®°å½•åˆ—è¡¨ -->
    <scroll-view scroll-y style="flex: 1; padding: 16rpx 0;">
      <!-- å†å²è®°å½•é¡¹ç›® -->
      <view wx:for="{{searchValue ? filteredHistory : historyList}}" wx:key="id" 
            class="sidebar-history-wrapper {{item.swiped ? 'swiped' : ''}}"
            bindtap="closeSwipeOnTapOutside" data-id="{{item.id}}">
        <!-- æ»‘åŠ¨æ“ä½œèƒŒæ™¯ -->
        <view class="swipe-actions">
          <view class="action-btn rename-btn" bindtap="startRename" data-id="{{item.id}}">
            <view class="action-text">é‡å‘½å</view>
          </view>
          <view class="action-btn delete-btn" bindtap="confirmDelete" data-id="{{item.id}}">
            <view class="action-text">åˆ é™¤</view>
          </view>
        </view>
        
        <!-- ä¸»è¦å†…å®¹ -->
        <view class="sidebar-history-item {{item.swiped ? 'swiped' : ''}}"
              bindtouchstart="onTouchStart"
              bindtouchmove="onTouchMove" 
              bindtouchend="onTouchEnd"
              bindtap="openHistory"
              data-id="{{item.id}}"
              data-index="{{index}}">
          <view class="sidebar-item-title">{{item.title}}</view>
          <view class="sidebar-item-preview">{{item.preview}}</view>
          <view class="sidebar-item-time">{{item.time}}</view>
        </view>
      </view>
      
      <!-- ç©ºçŠ¶æ€ - æœç´¢æ— ç»“æœ -->
      <view wx:if="{{searchValue && filteredHistory.length === 0}}" style="padding: 80rpx 0; text-align: center;">
        <view style="font-size: 80rpx; margin-bottom: 20rpx;">ğŸ”</view>
        <view style="font-size: 28rpx; color: #666; margin-bottom: 10rpx;">æœªæ‰¾åˆ°ç›¸å…³è®°å½•</view>
        <view style="font-size: 24rpx; color: #999;">è¯·å°è¯•å…¶ä»–å…³é”®è¯</view>
      </view>
      
      <!-- ç©ºçŠ¶æ€ - æ— å†å²è®°å½• -->
      <view wx:elif="{{!searchValue && historyList.length === 0}}" style="padding: 80rpx 0; text-align: center;">
        <view style="font-size: 80rpx; margin-bottom: 20rpx;">ğŸ’¬</view>
        <view style="font-size: 28rpx; color: #666; margin-bottom: 10rpx;">æš‚æ— å†å²è®°å½•</view>
        <view style="font-size: 24rpx; color: #999;">å¼€å§‹æ‚¨çš„ç¬¬ä¸€æ¬¡å¯¹è¯å§</view>
      </view>
    </scroll-view>
  </view>
</view>
