# 🚨 云函数部署问题修复指南

## 问题描述

错误信息：`-501000 | errMsg: FunctionName parameter could not be found`

这个错误表示云函数没有正确部署到云端环境。

## 🔧 修复步骤

### 步骤 1: 检查云开发环境

1. 打开微信开发者工具
2. 点击工具栏的 "云开发" 按钮
3. 确认你的环境 ID 是：`poultrygpt-6gmda5fva5c75a84`
4. 确保环境状态正常

### 步骤 2: 同步云函数列表

1. 在微信开发者工具中，右键点击 `cloudfunctions` 目录
2. 选择 **"同步云函数列表"**
3. 等待同步完成

### 步骤 3: 部署单个云函数

由于可能存在批量部署问题，建议逐个部署：

#### 3.1 部署 dify-chat 云函数

1. 右键点击 `cloudfunctions/dify-chat` 目录
2. 选择 **"上传并部署：云端安装依赖"**
3. 等待部署完成（可能需要 1-3 分钟）
4. 查看控制台输出，确认没有错误

#### 3.2 部署其他云函数

重复上述步骤，依次部署：

- `conversation-history`
- `upload-file`
- `audio-to-text`

### 步骤 4: 验证部署

1. 在云开发控制台中，进入 "云函数" 页面
2. 确认以下云函数都显示 "正常" 状态：
   - dify-chat
   - conversation-history
   - upload-file
   - audio-to-text

### 步骤 5: 测试调用

1. 在开发者工具中打开调试器
2. 在 Console 中执行以下代码测试云函数：

```javascript
wx.cloud
  .callFunction({
    name: "dify-chat",
    data: {
      action: "getInfo",
    },
  })
  .then((res) => {
    console.log("云函数调用成功:", res);
  })
  .catch((err) => {
    console.error("云函数调用失败:", err);
  });
```

### 步骤 6: 使用内置测试功能

1. 重新编译小程序
2. 在聊天页面右上角会出现 "测试连接" 按钮
3. 点击按钮进行自动测试
4. 查看控制台输出，了解具体错误信息

## 🔍 常见问题排查

### 问题 1: "上传并部署" 选项不可用

**解决方案：**

1. 确保已经开通云开发服务
2. 检查网络连接
3. 重启微信开发者工具

### 问题 2: 依赖安装失败

**解决方案：**

1. 手动进入云函数目录安装依赖：
   ```bash
   cd cloudfunctions/dify-chat
   npm install
   ```
2. 然后选择 "上传并部署：不安装依赖"

### 问题 3: 权限不足

**解决方案：**

1. 确保微信开发者账号有云开发权限
2. 检查是否是项目成员或管理员

### 问题 4: 环境不匹配

**解决方案：**

1. 确认 `app.ts` 中的环境 ID 与云开发控制台一致
2. 当前配置：`poultrygpt-6gmda5fva5c75a84`

### 问题 5: 参数传递错误

**解决方案：**

1. 检查云函数日志，查看具体错误信息
2. 确认前端传递的参数格式正确
3. 使用测试按钮进行调试

## 📱 小程序端检查

确保小程序端的环境配置正确：

```typescript
// miniprogram/app.ts
wx.cloud.init({
  env: "poultrygpt-6gmda5fva5c75a84", // 确保这个环境 ID 正确
  traceUser: true,
});
```

## 🎯 验证部署成功

部署成功后，你应该能看到：

1. **云开发控制台** - 显示所有云函数状态为 "正常"
2. **小程序控制台** - 没有 `-501000` 错误
3. **功能测试** - 能够发送消息并收到 AI 回复
4. **测试按钮** - 点击后显示 "测试成功"

## 📞 需要帮助？

如果按照上述步骤仍然有问题：

1. 检查云开发控制台的错误日志
2. 确保网络连接正常
3. 尝试重新创建云函数
4. 检查小程序的基础库版本（建议 >= 2.8.0）
5. 使用测试按钮获取详细错误信息

## 🚀 部署成功标志

当你看到小程序能够：

- ✅ 发送消息到 Dify AI
- ✅ 收到智能回复
- ✅ 管理对话历史
- ✅ 没有云函数错误
- ✅ 测试按钮显示 "测试成功"

就说明部署完全成功了！
